<!-- Main wrapper for the order tracking page -->
<div class="tracking-container">

    <!-- Header section -->
    <div class="header">
        <!-- Navigation link back to orders page -->
        <a routerLink="/orders" class="back-link">← Back to Orders</a>

        <!-- Page title -->
        <h2>Order Tracking</h2>
    </div>

    <!-- Loading state -->
    <!-- Shown only while data is being fetched -->
    <div *ngIf="loading" class="loading">
        Loading order details...
    </div>

    <!-- Error state -->
    <!-- Shown only if an error message exists -->
    <div *ngIf="errorMessage" class="error">
        {{ errorMessage }}
    </div>

    <!-- Main content -->
    <!-- Rendered only when order data exists -->
    <div *ngIf="order" class="order-details">

        <!-- ========================= -->
        <!-- Order Header Section -->
        <!-- ========================= -->
        <div class="order-header">

            <!-- Order basic info -->
            <div class="order-info">
                <!-- Order ID -->
                <h3>Order #{{ order.id }}</h3>

                <!-- Order creation date formatted using Angular DatePipe -->
                <p class="order-date">
                    Placed on {{ order.created_on | date:'medium' }}
                </p>
            </div>

            <!-- Order status badge -->
            <!-- CSS class changes based on order status -->
            <span [class]="'order-status ' + getStatusClass(currentStatus)">
                {{ currentStatus }}
            </span>
        </div>

        <!-- ========================= -->
        <!-- Progress Tracker -->
        <!-- ========================= -->
        <div class="progress-tracker">

            <!-- Horizontal progress bar -->
            <div class="progress-bar">
                <!-- Width is dynamically set using calculated width -->
                <div class="progress-fill" [style.width.%]="getProgressWidth()">
                </div>
            </div>

            <!-- Step indicators -->
            <!-- Step indicators -->
            <!-- Uses index-based logic: active if current step >= step index -->
            <div class="progress-steps">

                <!-- Pending step (Index 0) -->
                <div class="step" [class.active]="isStepActive(0)">
                    <div class="step-circle"></div>
                    <p>Pending</p>
                </div>

                <!-- Processing step (Index 1) -->
                <div class="step" [class.active]="isStepActive(1)">
                    <div class="step-circle"></div>
                    <p>Processing</p>
                </div>

                <!-- Shipped step (Index 2) -->
                <div class="step" [class.active]="isStepActive(2)">
                    <div class="step-circle"></div>
                    <p>Shipped</p>
                </div>

                <!-- Delivered step (Index 3) -->
                <div class="step" [class.active]="isStepActive(3)">
                    <div class="step-circle"></div>
                    <p>Delivered</p>
                </div>
            </div>
        </div>

        <!-- ========================= -->
        <!-- Tracking History List -->
        <!-- ========================= -->
        <div class="section history-section" *ngIf="history && history.length > 0">
            <h4>Tracking Details</h4>
            <div class="history-list">
                <div class="history-item" *ngFor="let step of history">
                    <div class="history-meta">
                        <span class="history-date">{{ step.changed_at | date:'medium' }}</span>
                    </div>
                    <div class="history-info">
                        <span [class]="'history-badge ' + getBadgeClass(step.status)">
                            {{ step.status }}
                        </span>
                        <span class="history-comment" *ngIf="step.comment">
                            {{ step.comment }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================= -->
        <!-- Order Items -->
        <!-- ========================= -->
        <div class="section">
            <h4>Order Item</h4>

            <div class="items-list">
                <!-- Iterate over normalized items array (handles single or multi-item responses) -->
                <div class="order-item" *ngFor="let item of items">
                    <div class="item-visual">
                        <img [src]="item.display_image" [alt]="item.display_name" class="item-thumb">
                    </div>

                    <!-- Product details -->
                    <div class="item-info">
                        <!-- Handles multiple backend response formats safely -->
                        <h5>{{ item.product?.name || item.display_name }}</h5>

                        <!-- Quantity -->
                        <p>Quantity: {{ item.quantity }}</p>
                    </div>

                    <!-- Item price formatted with number pipe -->
                    <p class="item-price">
                        ₹{{ item.price | number:'1.2-2' }}
                    </p>
                </div>
            </div>
        </div>

        <!-- ========================= -->
        <!-- Shipping Address -->
        <!-- ========================= -->
        <!-- Shown only if shipping address exists -->
        <div class="section" *ngIf="order.shipping_address">
            <h4>Shipping Address</h4>

            <div class="address-box">
                <p>{{ order.shipping_address.address }}</p>
                <p>
                    {{ order.shipping_address.city }},
                    {{ order.shipping_address.state }}
                    {{ order.shipping_address.pincode }}
                </p>
                <p>{{ order.shipping_address.country }}</p>
            </div>
        </div>

        <!-- ========================= -->
        <!-- Order Summary -->
        <!-- ========================= -->
        <div class="section">
            <h4>Order Summary</h4>

            <div class="summary-box">
                <!-- Subtotal calculation -->
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span>
                        ₹{{ subtotal | number:'1.2-2' }}
                    </span>
                </div>

                <!-- Final total -->
                <div class="summary-row total">
                    <span><strong>Total:</strong></span>
                    <span>
                        <strong>
                            ₹{{ (order.total_price || order.total) | number:'1.2-2' }}
                        </strong>
                    </span>
                </div>
            </div>
        </div>

        <!-- Debug Info -->
        <!-- Debug removed for production -->
    </div>
</div>